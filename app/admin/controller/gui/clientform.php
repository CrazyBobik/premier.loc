<?phpdefined( 'K_PATH' ) or die( 'DIRECT ACCESS IS NOT ALLOWED' );class Admin_Controller_Gui_Clientform extends Admin_Controller_Gui {    public function __construct($nodeData)    {		parent::__construct($this->_options);				$this->nodeData = $nodeData;    }		protected function newGUI()	{		return false;	}	protected function completedGUI()	{       	$this->tabs['completed'] = 'Заполненные формы';                $clientFormData = new Admin_Model_ClientFormData;           //загружаем данные формы            $formData = Gcontroller::loadclientFormStructure($this->nodeData['tree_link']);            /*    $clientFormData = $typeClientForm->fetchRow( K_Db_Select::create()->where( "type_clientform_id=$clientFormKey" ) );            $this->view->formStructure=unserialize( $clientFormData['type_clientform_content'] );*/            $formStructure = json_decode($formData['form_structure']);            $formStructure = K_Tree_Types::objectToArray($formStructure);                   $fieldCount=0;            $tableHead='';                   foreach ($formStructure as $v) {                    if (isset($v['values']['name']) && isset( $v['values']['label'])) {                      $tableHead.='<th title="'.$v['values']['label'].'">'.K_Str::trunc_ws($v['values']['label'],15, $wordsafe = false, $dots = true).'</th>';                          $colsKeys[] = $v['values']['name'];                      $fieldCount++;                      }              if ($fieldCount>3)break;           }              $tableHead='<tr><th>Дата</th>'.$tableHead.'<th>&nbsp;&nbspУправление&nbsp;&nbsp&nbsp;&nbsp</th></tr>';                return <<< HTML         <script type="text/javascript">                   $('#complited-forms-table-wrapper').ajaxLeaf(                  {                     loadUrl:'/admin/clientform/loadCompletedForms/',                     itemsContainer:'#complited-forms',                     xInfoHolder:'.info-holder',                                         "renderItems": function(items){                            var itemsHtml=[];                        var itemRow='';                        var id;                                            $.each(items, function(form,val) {                       itemRow='';                        $.each(val, function(k, v) {                                  if(k=='id'){                                     id=v;                                       }else{                                    itemRow+='<td>'+v+'</td>';                                  }                             });                            itemsHtml.push('<tr id="completed-form-row-'+id+'">'+itemRow+'<td wight="90"><img class="btn14" src="/adm/img/userRemove.png" onclick="delCompletedForm(\''+id+'\')" title="Удалить" alt="Удалить" /><img class="btn14" src="/adm/img/icons/showEye.png" onclick="seeCompletedForm(\''+id+'\')" title="Посмотреть полностью" alt="Посмотреть полностью" /></td></tr>');                                           })                        return itemsHtml;                    }                  }      );         	</script>          <div id="completed-form-warapp" class="acl-save-form-add" style="display:none">         <a href="javascript:;" title="Закрыть" class="close-link" onfocus="this.blur();"></a>           <h5 id="completed-form-head">Заполненная форма за <b> </b></h5>            <div id="completed-form-full"></div>          </div>                  <div style="display:none" class="nNote hideit" id="flash-msg-nNote">           <p></p>         </div>         <!-- Dynamic table -->         <div style="margin-top: 8px;" class="table" id="complited-forms-table-wrapper">											<div class="head">												<h5 class="iFrames">													Таблица заполненных форм												</h5>											</div>											<div class="dataTables_wrapper" id="acl-users_wrapper">																							<table cellspacing="0" cellpadding="0" border="0" class="display" id="complited-forms">													<thead>														<tr>														 {$tableHead}														</tr>													</thead>													<tbody>													</tbody>												</table>												<div class="fg-toolbar ui-toolbar ui-widget-header ui-corner-bl ui-corner-br ui-helper-clearfix">													<div id="acl-users_length" class="dataTables_length">														<label>															Элементов на страницу:															<select name="acl-users_length" class="on-page-count" size="1">                                                                <option value="5" selected="selected">																	5																</option>																<option value="10" selected="selected">																	10																</option>																<option value="25">																	25																</option>																<option value="50">																	50																</option>																<option value="100">																	100																</option>															</select>														</label>													</div>													<div class="dataTables_paginate fg-buttonset ui-buttonset fg-buttonset-multi ui-buttonset-multi paging_full_numbers" id="acl-users_paginate">											    	</div>												</div>											</div>                                            <p style="display:none" class="info-holder">tree_link={$this->nodeData['tree_link']}</p>										</div>         HTML;	}                            protected function formGUI()	{		$this->tabs['form'] = 'Форма';	        return <<< HTML        <script type="text/javascript">					$('#my-form-builder').formbuilder({				'save_url': '/admin/clientform/save/key/{$this->nodeData['tree_id']}',				'load_url': '/admin/clientform/load/key/{$this->nodeData['tree_id']}',				'useJson' : true,                 'xform':'client-form-xfields'			});			$('#my-form-builder ul').sortable();			        </script>		<div class="b-node_information">					<div>				[ <b>{$this->nodeData['tree_link']}</b> ]			</div>		</div>        <div id="my-form-builder">                    Дополнительные настройки:            <form class="formmain" id="client-form-xfields">                         <div class="frmbXfieldRow">                        <input id="ck-admin-email" class="fld-label" name="ck_admin_email" type="checkbox"/>                        <label for="ck-admin-email">Отправить форму на почту администратора</label>                        <br>                        <label> Почта администратора</label>                         <input type="text" name="admin_email" class="fld-label" class="b-field" />                </div>                              <div class="frmbXfieldRow">                     <input id="ck-client-email" name="ck_client_email" type="checkbox"/>                    <label for="ck-admin-email"> Отправить форму на почту клиента</label>                    <br />                     <label> Название поля для ввода почты пользователя</label>                      <input type="text" name="client_email_field_name" class="fld-label" class="b-field" />                     <br />                     <label> Название чекбокса</label>                      <input type="text" name="client_email_ck_name" class="fld-label" class="b-field" />                                      </div>                              <div class="frmbXfieldRow">                       Шаблон письма администратору<br />                       <textarea id="admin-mail-tmp" style="width: 100%;" name="admin_mail_tmp"></textarea>                </div>                <div class="frmbXfieldRow">                      Шаблон письма клиенту<br />                   <textarea id="client-mail-tmp" style="width: 100%;" name="client_mail_tmp"></textarea>                </div>                 <div class="frmbXfieldRow">                     <input id="ck-save-db" name="ck_save_db" type="checkbox"/>                    <label for="ck-save-db">Сохранять заполненные формы в базу данных</label>                 </div>            </form>     </div>        HTML;    }		protected function editGUI()	{		return false;	}}